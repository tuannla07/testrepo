############################################################################################################
# This template triggers a release pipeline in Azure DevOps.
# The pipeline to start should be either a pipeline that starts others or a pipeline that is used for releases.
#-----------------------------------------------------------------------------------------------------------
# Parameters:
# - DefinitionId: The ID of the pipeline definition to trigger.
# - BuildNumber: The build number to pass as a parameter to the triggered pipeline.
# - MainVersion: The main version to pass as a parameter to the triggered pipeline.
# - Tag: The tag to pass as a parameter to the triggered pipeline (default: "latest").
# - PoolName: The pool name to pass as a parameter to the triggered pipeline (default: "Azure Pipelines").
############################################################################################################

parameters:
  - name: DefinitionId
    type: string
    default: ""

  - name: BuildNumber
    type: string
    default: ""

  - name: MainVersion
    type: string
    default: ""

  - name: Tag
    type: string
    default: "latest" # should be latest in prod branch
    displayName: "Tag"

  - name: "PoolName"
    type: string
    default: "Azure Pipelines"
    values:
      - "Azure Pipelines"
      - "Omnia Agents"

steps:
  - script: |
      set -euo pipefail
      if([ -z "${{ parameters.DefinitionId }}" ]); then
        echo "‚ùå DefinitionId is not set. Skipping triggering release pipelines."
        exit 0
      fi

      echo "Triggering release pipeline..."
          response=$(curl -w "%{http_code}" -s -o response.json -u user:$(SYSTEM_ACCESSTOKEN) \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{
                  "definition": {
                    "id": ${{ parameters.DefinitionId }}
                  },
                  "parameters": "{ 
                    \"BuildNumber\": \"${{ parameters.BuildNumber }}\", 
                    \"MainVersion\": \"${{ parameters.MainVersion }}\", 
                    \"Tag\": \"${{ parameters.Tag }}\", 
                    \"PoolName\": \"${{ parameters.PoolName }}\"
                  }"
                }' \
            https://dev.azure.com/omnia-source/omnia/_apis/build/builds?api-version=7.1-preview.7)
      if [ "$http_code" != "200" ] && [ "$http_code" != "201" ]; then
        echo "Failed to trigger pipeline. Response:"
        cat response.json
        exit 1
      else
        echo "Pipeline triggered successfully."
      fi

    displayName: "Start Release pipeline"
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
